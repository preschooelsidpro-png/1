<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher - Attendance Marker</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #eef2f3; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        .status-box { margin-top: 20px; padding: 20px; border-radius: 10px; font-weight: bold; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .loading { background: #fff3cd; color: #856404; }
        .pulse { animation: pulse-animation 2s infinite; }
        @keyframes pulse-animation { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div class="card">
        <h2>Attendance Marker</h2>
        <p>‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫‡∂∫‡∑è‡∂ú‡∑ö NFC ‡∂ö‡∑è‡∂©‡∑ä‡∂¥‡∂≠ ‡∑É‡∑ä‡∂ö‡∑ë‡∂±‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.</p>
        <div id="loader" class="pulse">üì° Waiting for Scan...</div>
        <div id="status" class="status-box"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbOS4FlNNzYqOPjjf6xjjxWueC9gYFcLo",
            authDomain: "isia-4324b.firebaseapp.com",
            projectId: "isia-4324b",
            storageBucket: "isia-4324b.firebasestorage.app",
            appId: "1:981887431122:web:8e96c34367cb4228ff980b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // NFC ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∂ë‡∂± URL ‡∂ë‡∂ö‡∑ö ‡∂≠‡∑í‡∂∫‡∑ô‡∂± ID ‡∂ë‡∂ö ‡∂Ö‡∂ª‡∂ú‡∑ô‡∂± Attendance ‡∑É‡∂Ω‡∂ö‡∑î‡∂´‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫
        async function markAttendance() {
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('id');

            if (!studentId) return;

            const status = document.getElementById('status');
            status.style.display = "block";
            status.className = "status-box loading";
            status.innerText = "‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä...";

            try {
                const studentSnap = await getDoc(doc(db, "students", studentId));
                if (studentSnap.exists()) {
                    const studentData = studentSnap.data();
                    const now = new Date();
                    const dateStr = now.toISOString().split('T')[0];
                    const timeStr = now.toLocaleTimeString();

                    await addDoc(collection(db, "attendance"), {
                        studentId: studentId,
                        studentName: studentData.name,
                        date: dateStr,
                        time: timeStr
                    });

                    status.className = "status-box success";
                    status.innerText = `‚úÖ ${studentData.name} ‡∂ú‡∑ö ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑ì‡∂∏ ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∂ö‡∑Ö‡∑è!`;
                    
                    // ‡∂≠‡∂≠‡∑ä‡∂¥‡∂ª 3‡∂ö‡∂ß ‡∂¥‡∑É‡∑î ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∑É‡∑ñ‡∂Ø‡∑è‡∂±‡∂∏‡∑ä ‡∑Ä‡∑ô‡∂±‡∑ä‡∂±
                    setTimeout(() => {
                        status.style.display = "none";
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }, 3000);

                } else {
                    status.innerText = "‚ùå ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂±‡∑ú‡∑Ä‡∂± ‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫‡∂∫‡∑ô‡∂ö‡∑í.";
                }
            } catch (e) {
                status.innerText = "‚ùå ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑í: " + e.message;
            }
        }

        // ‡∂¥‡∑ö‡∂¢‡∑ä ‡∂ë‡∂ö ‡∂Ω‡∑ù‡∂©‡∑ä ‡∑Ä‡∑ô‡∂Ø‡∑ä‡∂Ø‡∑ì‡∂∏ URL ‡∂ë‡∂ö‡∑ö ID ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂≠‡∑í‡∂∫‡∑ö‡∂Ø ‡∂∂‡∂Ω‡∂±‡∑Ä‡∑è
        window.onload = markAttendance;
    </script>
</body>
</html>
