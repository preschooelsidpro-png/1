<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher - Attendance Marker</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); max-width: 450px; margin: auto; }
        .status-box { margin-top: 20px; padding: 20px; border-radius: 10px; font-weight: bold; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #e2e3e5; color: #383d41; }
        
        .scan-btn {
            background: #007bff; color: white; border: none; padding: 15px 30px;
            font-size: 18px; font-weight: bold; border-radius: 50px; cursor: pointer;
            margin-top: 20px; transition: background 0.3s;
        }
        .scan-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #log { margin-top: 20px; text-align: left; font-size: 13px; color: #666; max-height: 150px; overflow-y: auto; background: #fff; padding: 10px; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <h2 style="color: #333;">ISIA Attendance</h2>
        <p style="color: #666;">‡∂∏‡∑ô‡∂∏ ‡∂¥‡∑ö‡∂¢‡∑ä ‡∂ë‡∂ö ‡∑Ä‡∑í‡∑Ä‡∑ò‡∂≠‡∑Ä ‡∂¥‡∑Ä‡∂≠‡∑í‡∂± ‡∑Ä‡∑í‡∂ß ‡∂ö‡∑è‡∂©‡∑ä‡∂¥‡∂≠ ‡∑É‡∑ä‡∂ö‡∑ë‡∂±‡∑ä ‡∂ö‡∑Ö‡∑Ñ‡∑ú‡∂≠‡∑ä ‡∑É‡∑ä‡∑Ä‡∂∫‡∂Ç‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂∫‡∑Ä ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑ì‡∂∏ ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∑Ä‡∑ö.</p>
        
        <button id="startBtn" class="scan-btn">Start Scanning üì°</button>
        
        <div id="status" class="status-box"></div>
        
        <div id="log">
            <strong>‡∑É‡∑ä‡∂ö‡∑ë‡∂±‡∑ä ‡∂â‡∂≠‡∑í‡∑Ñ‡∑è‡∑É‡∂∫:</strong>
            <ul id="logList" style="list-style: none; padding: 0;"></ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbOS4FlNNzYqOPjjf6xjjxWueC9gYFcLo",
            authDomain: "isia-4324b.firebaseapp.com",
            projectId: "isia-4324b",
            storageBucket: "isia-4324b.firebasestorage.app",
            appId: "1:981887431122:web:8e96c34367cb4228ff980b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const logList = document.getElementById('logList');

        startBtn.onclick = async () => {
            if (!('NDEFReader' in window)) {
                showMessage("‚ùå ‡∑É‡∂∏‡∑è‡∑Ä‡∂±‡∑ä‡∂±, ‡∂î‡∂∂‡∑ö ‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂±‡∂∫ ‡∑Ñ‡∑ù Browser ‡∂ë‡∂ö NFC ‡∑Ä‡∂Ω‡∂ß ‡∑É‡∑Ñ‡∂∫ ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∂±‡∑ä‡∂±‡∑ö ‡∂±‡∑ê‡∂≠. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª Android Chrome ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.", "error");
                return;
            }

            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                
                startBtn.disabled = true;
                startBtn.innerText = "üì° Scanning Active...";
                showMessage("üì° ‡∂Ø‡∑ê‡∂±‡∑ä ‡∂ö‡∑è‡∂©‡∑ä‡∂¥‡∂≠ ‡∑É‡∑ä‡∂¥‡∂ª‡∑ä‡∑Å ‡∂ö‡∂ª‡∂±‡∑ä‡∂±...", "info");

                ndef.addEventListener("reading", async ({ message, serialNumber }) => {
                    // NFC ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä URL ‡∂ë‡∂ö ‡∂ö‡∑í‡∂∫‡∑Ä‡∑ì‡∂∏
                    for (const record of message.records) {
                        if (record.recordType === "url") {
                            const decoder = new TextDecoder();
                            const url = decoder.decode(record.data);
                            const studentId = new URL(url).searchParams.get('id');
                            
                            if (studentId) {
                                await processAttendance(studentId);
                            } else {
                                showMessage("‚ùå ‡∂ö‡∑è‡∂©‡∑ä‡∂¥‡∂≠‡∑ö ID ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑Ñ‡∂∏‡∑î ‡∑Ä‡∑î‡∂´‡∑ö ‡∂±‡∑ê‡∂≠.", "error");
                            }
                        }
                    }
                });

                ndef.addEventListener("readingerror", () => {
                    showMessage("‚ùå ‡∑É‡∑ä‡∂ö‡∑ë‡∂±‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∂Ö‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í. ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.", "error");
                });

            } catch (error) {
                showMessage("‚ùå ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑í: " + error.message, "error");
            }
        };

        async function processAttendance(studentId) {
            showMessage("<div class='loader'></div> ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä...", "info");
            
            try {
                const studentSnap = await getDoc(doc(db, "students", studentId));
                if (studentSnap.exists()) {
                    const studentData = studentSnap.data();
                    const now = new Date();
                    const dateStr = now.toISOString().split('T')[0];
                    const timeStr = now.toLocaleTimeString();

                    await addDoc(collection(db, "attendance"), {
                        studentId: studentId,
                        studentName: studentData.name,
                        date: dateStr,
                        time: timeStr
                    });

                    showMessage(`‚úÖ ${studentData.name} ‡∂ú‡∑ö ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑ì‡∂∏ ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∂ö‡∑Ö‡∑è!`, "success");
                    addToLog(studentData.name, timeStr);
                    
                    // ‡∂≠‡∂≠‡∑ä‡∂¥‡∂ª 2‡∂ö‡∂ß ‡∂¥‡∑É‡∑î ‡∂±‡∑ê‡∑Ä‡∂≠ Scanning Mode ‡∂ë‡∂ö‡∂ß ‡∂∫‡∂±‡∑ä‡∂±
                    setTimeout(() => showMessage("üì° ‡∂∏‡∑ì‡∑Ö‡∂ü ‡∂ö‡∑è‡∂©‡∑ä‡∂¥‡∂≠ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑É‡∑ñ‡∂Ø‡∑è‡∂±‡∂∏‡∑ä...", "info"), 2000);
                } else {
                    showMessage("‚ùå ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂±‡∑ú‡∑Ä‡∂± ‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫‡∂∫‡∑ô‡∂ö‡∑í.", "error");
                }
            } catch (e) {
                showMessage("‚ùå ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑í: " + e.message, "error");
            }
        }

        function showMessage(msg, type) {
            status.style.display = "block";
            status.className = `status-box ${type}`;
            status.innerHTML = msg;
        }

        function addToLog(name, time) {
            const li = document.createElement('li');
            li.innerHTML = `‚Ä¢ <b>${name}</b> - ${time}`;
            logList.prepend(li);
        }
    </script>
</body>
</html>
