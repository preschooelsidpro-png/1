<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISIA - Admin Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .admin-container {
            background: white;
            width: 100%;
            max-width: 600px;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h2 { text-align: center; color: #333; }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: #eee; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .tab-btn.active { background: #28a745; color: white; }

        .form-section { display: none; }
        .form-section.active { display: block; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .alert-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #fff3cd;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        button.main-btn {
            width: 100%;
            padding: 14px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        button.main-btn:hover { background-color: #0056b3; }

        #statusMsg { margin-top: 15px; text-align: center; padding: 10px; border-radius: 8px; display: none; }
        
        .recent-posts { margin-top: 30px; width: 100%; }
        .post-item { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; position: relative; }
        .delete-btn { position: absolute; top: 10px; right: 10px; background: #ff4d4d; color: white; border: none; border-radius: 5px; cursor: pointer; padding: 5px 10px; }

        /* Attendance Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; font-size: 14px; }
        th { background: #f8f9fa; }
    </style>
</head>
<body>

    <div class="admin-container">
        <h2>üöÄ ISIA Control Panel</h2>

        <div class="tab-buttons">
            <button class="tab-btn active" onclick="showTab('newPost')">‡∂±‡∑Ä ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä</button>
            <button class="tab-btn" onclick="showTab('manageStudent')">‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫ ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©</button>
            <button class="tab-btn" onclick="showTab('viewAttendance')">‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑ì‡∂∏‡∑ö ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è</button>
        </div>

        <!-- Section 1: Create New Post -->
        <div id="newPost" class="form-section active">
            <div class="form-group">
                <label>‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂∏‡∑è‡∂≠‡∑ò‡∂ö‡∑è‡∑Ä (Title)</label>
                <input type="text" id="postTitle" placeholder="Ex: ‡∂±‡∑í‡∑Ä‡∑è‡∂©‡∑î ‡∂Ø‡∑ê‡∂±‡∑î‡∂∏‡∑ä‡∂Ø‡∑ì‡∂∏">
            </div>
            <div class="form-group">
                <label>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫ (Body)</label>
                <textarea id="postBody" rows="4" placeholder="‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∂∏‡∑ô‡∂≠‡∂± ‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂±..."></textarea>
            </div>
            <div class="form-group">
                <label>‡∂¥‡∑í‡∂±‡∑ä‡∂≠‡∑ñ‡∂ª ‡∂Ω‡∑í‡∂±‡∑ä‡∂ö‡∑ä (Image URL - Optional)</label>
                <input type="url" id="postImageUrl" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>‡∑Ä‡∑ì‡∂©‡∑í‡∂∫‡∑ù ‡∂Ω‡∑í‡∂±‡∑ä‡∂ö‡∑ä (YouTube URL - Optional)</label>
                <input type="url" id="postVideoUrl" placeholder="https://youtube.com/...">
            </div>

            <div class="alert-toggle">
                <input type="checkbox" id="isAlert" style="width: auto;">
                <label for="isAlert" style="margin:0; color: #856404;">‡∂∏‡∑ô‡∂∫ ‡∑Ä‡∑ê‡∂Ø‡∂ú‡∂≠‡∑ä ‡∂Ø‡∑ê‡∂±‡∑î‡∂∏‡∑ä‡∂Ø‡∑ì‡∂∏‡∂ö‡∑ä (Alert) ‡∂Ω‡∑ô‡∑É ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±</label>
            </div>

            <div class="form-group">
                <label>‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î ‡∂ö‡∑è‡∂´‡∑ä‡∂©‡∂∫ (Target)</label>
                <select id="targetType" onchange="toggleTargetInput()">
                    <option value="all">‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∂Ø‡∑ô‡∂±‡∑è‡∂ß (Global)</option>
                    <option value="grade">‡∑Å‡∑ä‚Äç‡∂ª‡∑ö‡∂´‡∑í‡∂∫‡∂ö‡∂ß (Grade)</option>
                    <option value="class">‡∂¥‡∂±‡∑ä‡∂≠‡∑í‡∂∫‡∂ö‡∂ß (Class)</option>
                    <option value="individual">‡∂ë‡∂ö‡∑ä ‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫‡∂∫‡∑ô‡∂ö‡∑î‡∂ß (Individual)</option>
                </select>
            </div>
            
            <div id="targetValueDiv" class="form-group" style="display:none;">
                <label id="targetLabel">‡∂Ö‡∂Ø‡∑è‡∑Ö ‡∂Ö‡∂ú‡∂∫ (Target Value)</label>
                <select id="gradeSelect" style="display:none;">
                    <option value="Preschool">Preschool</option>
                    <option value="1">Grade 1</option><option value="2">Grade 2</option>
                    <option value="3">Grade 3</option><option value="4">Grade 4</option>
                    <option value="5">Grade 5</option><option value="6">Grade 6</option>
                    <option value="7">Grade 7</option><option value="8">Grade 8</option>
                    <option value="9">Grade 9</option><option value="10">Grade 10</option>
                    <option value="11">Grade 11</option>
                </select>
                <select id="classSelect" style="display:none;">
                    <option value="1-A">1-A</option><option value="2-A">2-A</option>
                    <option value="3-A">3-A</option><option value="4-A">4-A</option>
                    <option value="5-A">5-A</option>
                </select>
                <input type="text" id="targetValueInput" placeholder="Student ID" style="display:none;">
            </div>

            <button class="main-btn" id="publishBtn">‡∂¥‡∂Ω ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Publish)</button>
        </div>

        <!-- Section 2: Manage Student Specific Note -->
        <div id="manageStudent" class="form-section">
            <div class="form-group">
                <label>‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫ ID ‡∂ë‡∂ö (Student Document ID)</label>
                <input type="text" id="manageStudentId" placeholder="ID ‡∂ë‡∂ö ‡∂∏‡∑ô‡∂≠‡∂± paste ‡∂ö‡∂ª‡∂±‡∑ä‡∂±">
            </div>
            <div class="form-group">
                <label>‡∂Ø‡∑ô‡∂∏‡∑è‡∂¥‡∑í‡∂∫‡∂±‡∑ä ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂¥‡∑û‡∂Ø‡∑ä‡∂ú‡∂Ω‡∑í‡∂ö ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ (Parent Note)</label>
                <textarea id="parentNote" rows="3" placeholder="‡∂∏‡∑ô‡∂∏ ‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫‡∂∫‡∑è‡∂ú‡∑ö ‡∂Ø‡∑ô‡∂∏‡∑è‡∂¥‡∑í‡∂∫‡∂±‡∑ä‡∂ß ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂± ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫..."></textarea>
            </div>
            <button class="main-btn" style="background-color: #28a745;" id="updateStudentBtn">‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Update Note)</button>
        </div>

        <!-- Section 3: View Attendance Log -->
        <div id="viewAttendance" class="form-section">
            <h3>‡∂Ö‡∂Ø ‡∂Ø‡∑í‡∂± ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑ì‡∂∏‡∑ö ‡∂Ω‡∑ö‡∂õ‡∂±‡∂∫</h3>
            <div id="attendanceList">‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂Ω‡∂∂‡∑è ‡∂ú‡∂±‡∑í‡∂∏‡∑í‡∂±‡∑ä...</div>
        </div>

        <div id="statusMsg"></div>

        <div class="recent-posts">
            <h3>‡∂∏‡∑ë‡∂≠‡∂ö‡∂Ø‡∑ì ‡∂¥‡∂Ω ‡∂ö‡∑Ö ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä</h3>
            <div id="postsList">‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂Ω‡∂∂‡∑è ‡∂ú‡∂±‡∑í‡∂∏‡∑í‡∂±‡∑ä...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, getDocs, deleteDoc, doc, updateDoc, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbOS4FlNNzYqOPjjf6xjjxWueC9gYFcLo",
            authDomain: "isia-4324b.firebaseapp.com",
            projectId: "isia-4324b",
            storageBucket: "isia-4324b.firebasestorage.app",
            messagingSenderId: "981887431122",
            appId: "1:981887431122:web:8e96c34367cb4228ff980b",
            measurementId: "G-10N2QR8W12"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.showTab = (tabId) => {
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
            if(tabId === 'viewAttendance') loadAttendance();
        };

        window.toggleTargetInput = () => {
            const type = document.getElementById('targetType').value;
            const container = document.getElementById('targetValueDiv');
            const gradeSelect = document.getElementById('gradeSelect');
            const classSelect = document.getElementById('classSelect');
            const idInput = document.getElementById('targetValueInput');

            container.style.display = type === 'all' ? 'none' : 'block';
            gradeSelect.style.display = type === 'grade' ? 'block' : 'none';
            classSelect.style.display = type === 'class' ? 'block' : 'none';
            idInput.style.display = type === 'individual' ? 'block' : 'none';
        };

        document.getElementById('publishBtn').onclick = async () => {
            const btn = document.getElementById('publishBtn');
            const type = document.getElementById('targetType').value;
            let val = 'global';
            if(type === 'grade') val = document.getElementById('gradeSelect').value;
            else if(type === 'class') val = document.getElementById('classSelect').value;
            else if(type === 'individual') val = document.getElementById('targetValueInput').value;

            const data = {
                title: document.getElementById('postTitle').value,
                body: document.getElementById('postBody').value,
                imageUrl: document.getElementById('postImageUrl').value,
                videoUrl: document.getElementById('postVideoUrl').value,
                isAlert: document.getElementById('isAlert').checked,
                targetType: type,
                targetValue: val,
                createdAt: serverTimestamp()
            };

            if(!data.title || !data.body) return alert("Fields missing");

            try {
                await addDoc(collection(db, "posts"), data);
                location.reload();
            } catch (e) { alert(e.message); }
        };

        async function loadAttendance() {
            const list = document.getElementById('attendanceList');
            const today = new Date().toISOString().split('T')[0];
            const q = query(collection(db, "attendance"), where("date", "==", today));
            const snap = await getDocs(q);
            
            let html = '<table><tr><th>‡∂±‡∂∏</th><th>‡∑Ä‡∑ö‡∂Ω‡∑è‡∑Ä</th></tr>';
            snap.forEach(doc => {
                const d = doc.data();
                html += `<tr><td>${d.studentName}</td><td>${d.time}</td></tr>`;
            });
            html += '</table>';
            list.innerHTML = snap.empty ? '‡∂Ö‡∂Ø ‡∂Ø‡∑í‡∂± ‡∂ö‡∑í‡∑É‡∑í‡∂Ø‡∑î ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑ì‡∂∏‡∂ö‡∑ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∑Ä‡∑ì ‡∂±‡∑ê‡∂≠.' : html;
        }

        async function loadPosts() {
            const listEl = document.getElementById('postsList');
            const q = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(5));
            const snap = await getDocs(q);
            listEl.innerHTML = '';
            snap.forEach(postDoc => {
                const d = postDoc.data();
                const div = document.createElement('div');
                div.className = 'post-item';
                div.innerHTML = `<strong>${d.title}</strong> <button class="delete-btn" onclick="deletePost('${postDoc.id}')">‡∂∏‡∂ö‡∂±‡∑ä‡∂±</button>`;
                listEl.appendChild(div);
            });
        }

        window.deletePost = async (id) => {
            if(confirm("Sure?")) { await deleteDoc(doc(db, "posts", id)); loadPosts(); }
        };

        loadPosts();
    </script>
</body>
</html>
