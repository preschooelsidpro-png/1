<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISIA - Student Profile</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Profile Header */
        .profile-card {
            background: white;
            width: 100%;
            max-width: 500px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            margin-bottom: 20px;
        }

        .profile-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #28a745;
            margin-bottom: 10px;
            background: #eee;
        }

        .student-name { font-size: 22px; font-weight: bold; color: #333; margin: 5px 0; }
        .student-info { color: #666; font-size: 14px; margin-bottom: 15px; }

        /* Parent Notifications Section */
        .notification-box {
            width: 90%;
            max-width: 460px;
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none; /* Hidden by default */
        }
        .notification-title {
            font-weight: bold;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        /* Feed Section */
        .feed-container {
            width: 95%;
            max-width: 500px;
            padding-bottom: 50px;
        }

        .post-card {
            background: white;
            border-radius: 15px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .post-content { padding: 15px; }
        .post-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 8px; }
        .post-body { font-size: 14px; color: #555; line-height: 1.5; margin-bottom: 10px; white-space: pre-wrap; }
        
        .post-media { width: 100%; margin: 0; }
        .post-media img {
            width: 100%;
            display: block;
            background: #eee;
        }

        /* Fixed Video Container */
        .video-wrapper {
            width: 100%;
            background: #000;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%; 
            height: 0;
            overflow: hidden;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        .post-date {
            font-size: 11px;
            color: #999;
            padding: 10px 15px 15px 15px;
            text-align: right;
        }

        #loading { margin-top: 50px; font-weight: bold; color: #666; padding: 20px; text-align: center; }
        .no-posts { text-align: center; color: #999; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="profileSection" class="profile-card" style="display:none;">
        <img id="displayPhoto" src="" alt="Profile" class="profile-img">
        <div id="displayName" class="student-name">Loading...</div>
        <div id="displayDetails" class="student-info">Admission No: -- | Grade: --</div>
    </div>

    <!-- Parent Notifications Box -->
    <div id="notificationBox" class="notification-box">
        <div class="notification-title">
            ⚠️ වැදගත් දැනුම්දීමක්
        </div>
        <div id="notificationText" style="font-size: 14px; color: #856404;"></div>
    </div>

    <div id="feed" class="feed-container">
        <div id="loading">දත්ත ලබා ගනිමින්...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbOS4FlNNzYqOPjjf6xjjxWueC9gYFcLo",
            authDomain: "isia-4324b.firebaseapp.com",
            projectId: "isia-4324b",
            storageBucket: "isia-4324b.firebasestorage.app",
            messagingSenderId: "981887431122",
            appId: "1:981887431122:web:8e96c34367cb4228ff980b",
            measurementId: "G-10N2QR8W12"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const fallbackSVG = "data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 24 24' fill='none' stroke='%23ccc' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'%3e%3ccircle cx='12' cy='8' r='5'/%3e%3cpath d='M3 21v-2a7 7 0 0 1 14 0v2'/%3e%3c/svg%3e";

        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('id');

        if (!studentId) {
            document.getElementById('loading').innerHTML = "❌ අවලංගු ID එකක්.";
        } else {
            loadStudentData();
        }

        async function loadStudentData() {
            try {
                const docRef = doc(db, "students", studentId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('profileSection').style.display = 'block';
                    document.getElementById('displayName').textContent = data.name || 'Unknown Student';
                    document.getElementById('displayDetails').textContent = `Admission: ${data.admissionNo || '--'} | Grade: ${data.grade || '--'}-${data.classGroup || '--'}`;
                    
                    let studentPhoto = (data.photoUrl || "").trim();
                    const photoImg = document.getElementById('displayPhoto');
                    
                    photoImg.onerror = () => { photoImg.src = fallbackSVG; };

                    if (studentPhoto && studentPhoto !== "" && studentPhoto !== "undefined") {
                        if (studentPhoto.includes('dropbox.com')) {
                            studentPhoto = studentPhoto.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '').replace('?dl=1', '');
                        }
                        photoImg.src = studentPhoto;
                    } else {
                        photoImg.src = fallbackSVG;
                    }

                    // Load specific notification if available in student record
                    if(data.parentNote) {
                        document.getElementById('notificationBox').style.display = 'block';
                        document.getElementById('notificationText').textContent = data.parentNote;
                    }

                    loadPostsOnce(data.grade, data.classGroup);
                } else {
                    document.getElementById('loading').innerHTML = "❌ ශිෂ්‍යයා සොයාගත නොහැක.";
                }
            } catch (e) {
                console.error("Firestore Error:", e);
                document.getElementById('loading').innerHTML = "❌ දෝෂයකි.";
            }
        }

        async function loadPostsOnce(grade, classGroup) {
            const feedEl = document.getElementById('feed');
            const classKey = `${grade}-${classGroup}`;

            try {
                const querySnapshot = await getDocs(collection(db, "posts"));
                document.getElementById('loading').style.display = 'none';
                feedEl.innerHTML = ''; 
                
                let postsArray = [];
                querySnapshot.forEach((postDoc) => {
                    const post = postDoc.data();
                    let isRelevant = false;
                    
                    // Check for global notifications (targetType: all)
                    if (post.targetType === 'all' || post.targetValue === 'global') {
                        isRelevant = true;
                        // If it's a high priority post, show it in the notification box too
                        if(post.isAlert) {
                            document.getElementById('notificationBox').style.display = 'block';
                            document.getElementById('notificationText').textContent = post.title + ": " + post.body;
                        }
                    }

                    if (post.targetType === 'grade' && String(post.targetValue) === String(grade)) isRelevant = true;
                    if (post.targetType === 'class' && String(post.targetValue) === String(classKey)) isRelevant = true;
                    if (post.targetType === 'individual' && post.targetValue === studentId) isRelevant = true;

                    if (isRelevant) postsArray.push(post);
                });

                postsArray.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                if (postsArray.length > 0) {
                    postsArray.forEach(post => renderPost(post));
                } else {
                    feedEl.innerHTML = '<div class="no-posts">පණිවිඩ කිසිවක් නැත.</div>';
                }
            } catch (err) {
                console.error(err);
            }
        }

        function renderPost(post) {
            const feedEl = document.getElementById('feed');
            const postDate = post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleString() : 'Just now';
            
            const videoUrl = (post.videoUrl || "").trim();
            const imageUrl = (post.imageUrl || "").trim();

            let videoHTML = '';
            if (videoUrl) {
                const videoId = extractYouTubeId(videoUrl);
                if (videoId) {
                    videoHTML = `
                        <div class="video-wrapper">
                            <div class="video-container">
                                <iframe 
                                    src="https://www.youtube.com/embed/${videoId}?rel=0" 
                                    title="YouTube video player" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                    allowfullscreen>
                                </iframe>
                            </div>
                        </div>`;
                }
            }

            let imageHTML = '';
            if (imageUrl) {
                let finalImgUrl = imageUrl;
                if (finalImgUrl.includes('dropbox.com')) {
                    finalImgUrl = finalImgUrl.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '').replace('?dl=1', '');
                }
                imageHTML = `<div class="post-media"><img src="${finalImgUrl}" onerror="this.parentElement.style.display='none'"></div>`;
            }

            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            postCard.innerHTML = `
                <div class="post-content">
                    <div class="post-title">${post.title || 'Update'}</div>
                    <div class="post-body">${post.body || ''}</div>
                </div>
                ${imageHTML}
                ${videoHTML}
                <div class="post-date">${postDate}</div>
            `;
            feedEl.appendChild(postCard);
        }

        function extractYouTubeId(url) {
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            
            if (match && match[7] && match[7].length === 11) {
                return match[7];
            } else {
                const shortsMatch = url.match(/shorts\/([a-zA-Z0-9_-]{11})/);
                if (shortsMatch) return shortsMatch[1];
                const liveMatch = url.match(/live\/([a-zA-Z0-9_-]{11})/);
                if (liveMatch) return liveMatch[1];
                return null;
            }
        }
    </script>
</body>
</html>
