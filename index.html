<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISIA - Student Profile</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Profile Header */
        .profile-card {
            background: white;
            width: 100%;
            max-width: 500px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            margin-bottom: 20px;
        }

        .profile-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #28a745;
            margin-bottom: 10px;
            background: #eee;
        }

        .student-name { font-size: 22px; font-weight: bold; color: #333; margin: 5px 0; }
        .student-info { color: #666; font-size: 14px; margin-bottom: 15px; }

        /* Feed Section */
        .feed-container {
            width: 95%;
            max-width: 500px;
            padding-bottom: 50px;
        }

        .post-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .post-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 8px; }
        .post-body { font-size: 14px; color: #555; line-height: 1.5; margin-bottom: 10px; }
        
        .post-media img {
            width: 100%;
            border-radius: 10px;
            margin-top: 10px;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 ratio */
            height: 0;
            overflow: hidden;
            border-radius: 10px;
            margin-top: 10px;
            background: #000;
        }

        .video-container iframe {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border: 0;
        }

        .post-date {
            font-size: 11px;
            color: #999;
            margin-top: 10px;
            text-align: right;
        }

        #loading { margin-top: 50px; font-weight: bold; color: #666; padding: 20px; text-align: center; }
        .no-posts { text-align: center; color: #999; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="profileSection" class="profile-card" style="display:none;">
        <img id="displayPhoto" src="" alt="Profile" class="profile-img" onerror="this.src='https://via.placeholder.com/120?text=No+Photo'">
        <div id="displayName" class="student-name">Loading...</div>
        <div id="displayDetails" class="student-info">Admission No: -- | Grade: --</div>
    </div>

    <div id="feed" class="feed-container">
        <div id="loading">ප්‍රෝෆයිලය පරීක්ෂා කරමින්...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbOS4FlNNzYqOPjjf6xjjxWueC9gYFcLo",
            authDomain: "isia-4324b.firebaseapp.com",
            projectId: "isia-4324b",
            storageBucket: "isia-4324b.firebasestorage.app",
            messagingSenderId: "981887431122",
            appId: "1:981887431122:web:8e96c34367cb4228ff980b",
            measurementId: "G-10N2QR8W12"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('id');

        if (!studentId) {
            document.getElementById('loading').innerHTML = "❌ අවලංගු ID එකක්. කරුණාකර නැවත NFC එක ස්කෑන් කරන්න.";
        } else {
            loadStudentData();
        }

        async function loadStudentData() {
            try {
                const docRef = doc(db, "students", studentId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('profileSection').style.display = 'block';
                    document.getElementById('displayName').textContent = data.name;
                    document.getElementById('displayDetails').textContent = `Admission: ${data.admissionNo} | Grade: ${data.grade}-${data.classGroup}`;
                    if(data.photoUrl) document.getElementById('displayPhoto').src = data.photoUrl;

                    loadPosts(data.grade, data.classGroup);
                } else {
                    document.getElementById('loading').innerHTML = "❌ ශිෂ්‍යයා සොයාගත නොහැක.";
                }
            } catch (e) {
                console.error(e);
                document.getElementById('loading').innerHTML = "❌ දත්ත ලබාගැනීමේදී දෝෂයක් සිදු විය.";
            }
        }

        function loadPosts(grade, classGroup) {
            const feedEl = document.getElementById('feed');
            const classKey = `${grade}-${classGroup}`;

            // Error වැලැක්වීම සඳහා orderBy ඉවත් කර පෝස්ට් කියවනවා
            const q = collection(db, "posts");

            onSnapshot(q, (snapshot) => {
                const loadingEl = document.getElementById('loading');
                if(loadingEl) loadingEl.style.display = 'none';
                
                feedEl.innerHTML = ''; 

                let postsArray = [];

                snapshot.forEach((postDoc) => {
                    const post = postDoc.data();
                    
                    let isRelevant = false;
                    if (post.targetType === 'all') isRelevant = true;
                    if (post.targetType === 'grade' && post.targetValue === grade) isRelevant = true;
                    if (post.targetType === 'class' && post.targetValue === classKey) isRelevant = true;
                    if (post.targetType === 'individual' && post.targetValue === studentId) isRelevant = true;

                    if (isRelevant) {
                        postsArray.push(post);
                    }
                });

                // පෝස්ට් ටික අලුත්ම ඒවා මුලට එන විදිහට JavaScript වලින් Sort කරනවා
                postsArray.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.seconds : 0;
                    const dateB = b.createdAt ? b.createdAt.seconds : 0;
                    return dateB - dateA;
                });

                if (postsArray.length > 0) {
                    postsArray.forEach(post => renderPost(post));
                } else {
                    feedEl.innerHTML = '<div class="no-posts">තවමත් අලුත් පණිවිඩ කිසිවක් නැත.</div>';
                }
            }, (error) => {
                console.error("Feed error:", error);
                document.getElementById('loading').innerHTML = "❌ පෝස්ට් ලෝඩ් කිරීමේදී දෝෂයක් සිදු විය.";
            });
        }

        function renderPost(post) {
            const feedEl = document.getElementById('feed');
            const postDate = post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleDateString() : 'Just now';

            let videoHTML = '';
            if (post.videoUrl) {
                let videoId = extractYouTubeId(post.videoUrl);
                if (videoId) {
                    videoHTML = `
                        <div class="video-container">
                            <iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>
                        </div>`;
                }
            }

            let imageHTML = '';
            if (post.imageUrl) {
                let finalImgUrl = post.imageUrl;
                if(finalImgUrl.includes('drive.google.com')){
                    finalImgUrl = finalImgUrl.replace('/view?usp=sharing', '').replace('file/d/', 'uc?export=view&id=').replace('/view', '');
                }
                imageHTML = `<div class="post-media"><img src="${finalImgUrl}" onerror="this.style.display='none'"></div>`;
            }

            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            postCard.innerHTML = `
                <div class="post-title">${post.title}</div>
                <div class="post-body">${post.body || ''}</div>
                ${imageHTML}
                ${videoHTML}
                <div class="post-date">${postDate}</div>
            `;
            feedEl.appendChild(postCard);
        }

        function extractYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }
    </script>
</body>
</html>
