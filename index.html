<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISIA - Student Profile</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Profile Header */
        .profile-card {
            background: white;
            width: 100%;
            max-width: 500px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            margin-bottom: 20px;
        }

        .profile-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #28a745;
            margin-bottom: 10px;
            background: #eee;
        }

        .student-name { font-size: 22px; font-weight: bold; color: #333; margin: 5px 0; }
        .student-info { color: #666; font-size: 14px; margin-bottom: 15px; }

        /* Feed Section */
        .feed-container {
            width: 95%;
            max-width: 500px;
            padding-bottom: 50px;
        }

        .post-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .post-content { padding: 15px; }
        .post-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 8px; }
        .post-body { font-size: 14px; color: #555; line-height: 1.5; margin-bottom: 10px; white-space: pre-wrap; }
        
        .post-media { width: 100%; margin: 0; }
        .post-media img {
            width: 100%;
            display: block;
            background: #eee;
        }

        .video-wrapper {
            width: 100%;
            background: #000;
            line-height: 0;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
        }

        .video-container iframe {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border: 0;
        }

        .post-date {
            font-size: 11px;
            color: #999;
            margin-top: 10px;
            padding: 0 15px 15px 15px;
            text-align: right;
        }

        #loading { margin-top: 50px; font-weight: bold; color: #666; padding: 20px; text-align: center; }
        .no-posts { text-align: center; color: #999; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="profileSection" class="profile-card" style="display:none;">
        <img id="displayPhoto" src="" alt="Profile" class="profile-img">
        <div id="displayName" class="student-name">Loading...</div>
        <div id="displayDetails" class="student-info">Admission No: -- | Grade: --</div>
    </div>

    <div id="feed" class="feed-container">
        <div id="loading">දත්ත ලබා ගනිමින්...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbOS4FlNNzYqOPjjf6xjjxWueC9gYFcLo",
            authDomain: "isia-4324b.firebaseapp.com",
            projectId: "isia-4324b",
            storageBucket: "isia-4324b.firebasestorage.app",
            messagingSenderId: "981887431122",
            appId: "1:981887431122:web:8e96c34367cb4228ff980b",
            measurementId: "G-10N2QR8W12"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // SVG fallback placeholder instead of external URL
        const fallbackSVG = "data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 24 24' fill='none' stroke='%23ccc' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'%3e%3ccircle cx='12' cy='8' r='5'/%3e%3cpath d='M3 21v-2a7 7 0 0 1 14 0v2'/%3e%3c/svg%3e";

        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('id');

        if (!studentId) {
            document.getElementById('loading').innerHTML = "❌ අවලංගු ID එකක්. කරුණාකර නැවත NFC එක ස්කෑන් කරන්න.";
        } else {
            loadStudentData();
        }

        async function loadStudentData() {
            try {
                const docRef = doc(db, "students", studentId);
                const docSnap = await getDoc(docRef);

                const photoImg = document.getElementById('displayPhoto');
                photoImg.onerror = () => { photoImg.src = fallbackSVG; };

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('profileSection').style.display = 'block';
                    document.getElementById('displayName').textContent = data.name || 'Unknown Student';
                    document.getElementById('displayDetails').textContent = `Admission: ${data.admissionNo || '--'} | Grade: ${data.grade || '--'}-${data.classGroup || '--'}`;
                    
                    let studentPhoto = data.photoUrl || "";
                    // Dropbox logic for student profile photo
                    if (studentPhoto.includes('dropbox.com')) {
                        studentPhoto = studentPhoto.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '').replace('?dl=1', '');
                    }

                    if(studentPhoto && studentPhoto.trim() !== "" && studentPhoto !== "undefined") {
                        photoImg.src = studentPhoto;
                    } else {
                        photoImg.src = fallbackSVG;
                    }

                    // Fetch posts only once
                    loadPostsOnce(data.grade, data.classGroup);
                } else {
                    document.getElementById('loading').innerHTML = "❌ ශිෂ්‍යයා සොයාගත නොහැක.";
                }
            } catch (e) {
                console.error("Error loading student data:", e);
                document.getElementById('loading').innerHTML = "❌ දත්ත ලබාගැනීමේදී දෝෂයක් සිදු විය.";
            }
        }

        async function loadPostsOnce(grade, classGroup) {
            const feedEl = document.getElementById('feed');
            const classKey = `${grade}-${classGroup}`;

            try {
                const querySnapshot = await getDocs(collection(db, "posts"));
                
                const loadingEl = document.getElementById('loading');
                if(loadingEl) loadingEl.style.display = 'none';
                
                feedEl.innerHTML = ''; 
                let postsArray = [];

                querySnapshot.forEach((postDoc) => {
                    const post = postDoc.data();
                    
                    let isRelevant = false;
                    if (post.targetType === 'all' || post.targetValue === 'global') isRelevant = true;
                    if (post.targetType === 'grade' && String(post.targetValue) === String(grade)) isRelevant = true;
                    if (post.targetType === 'class' && String(post.targetValue) === String(classKey)) isRelevant = true;
                    if (post.targetType === 'individual' && post.targetValue === studentId) isRelevant = true;

                    if (isRelevant) {
                        postsArray.push(post);
                    }
                });

                postsArray.sort((a, b) => {
                    const dateA = (a.createdAt && a.createdAt.seconds) ? a.createdAt.seconds : 0;
                    const dateB = (b.createdAt && b.createdAt.seconds) ? b.createdAt.seconds : 0;
                    return dateB - dateA;
                });

                if (postsArray.length > 0) {
                    postsArray.forEach(post => renderPost(post));
                } else {
                    feedEl.innerHTML = '<div class="no-posts">තවමත් අලුත් පණිවිඩ කිසිවක් නැත.</div>';
                }
            } catch (err) {
                console.error("Error loading posts:", err);
                document.getElementById('loading').innerHTML = "❌ පණිවිඩ ලබාගැනීමේදී දෝෂයක් සිදු විය.";
            }
        }

        function renderPost(post) {
            const feedEl = document.getElementById('feed');
            const postDate = post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleString() : 'Just now';

            const videoUrl = (post.videoUrl || post.video || "").toString().trim();
            const imageUrl = (post.imageUrl || post.image || "").toString().trim();
            const bodyText = (post.body || post.message || post.description || "");

            let videoHTML = '';
            if (videoUrl !== "" && videoUrl !== "undefined") {
                const videoId = extractYouTubeId(videoUrl);
                if (videoId) {
                    videoHTML = `
                        <div class="video-wrapper">
                            <div class="video-container">
                                <iframe 
                                    src="https://www.youtube.com/embed/${videoId}?rel=0" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                                </iframe>
                            </div>
                        </div>`;
                }
            }

            let imageHTML = '';
            if (imageUrl !== "" && imageUrl !== "undefined") {
                let finalImgUrl = imageUrl;
                
                // Google Drive Link Logic
                if(finalImgUrl.includes('drive.google.com')){
                    const driveIdMatch = finalImgUrl.match(/[-\w]{25,}/);
                    if (driveIdMatch) {
                        finalImgUrl = `https://docs.google.com/uc?export=view&id=${driveIdMatch[0]}`;
                    }
                } 
                // Dropbox Link Logic: convert to direct link
                else if (finalImgUrl.includes('dropbox.com')) {
                    finalImgUrl = finalImgUrl.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '').replace('?dl=1', '');
                }

                if (finalImgUrl.length > 5) {
                    imageHTML = `<div class="post-media"><img src="${finalImgUrl}" alt="Post Media" onerror="this.parentElement.style.display='none'"></div>`;
                }
            }

            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            postCard.innerHTML = `
                <div class="post-content">
                    <div class="post-title">${post.title || 'පණිවිඩයක්'}</div>
                    <div class="post-body">${bodyText}</div>
                </div>
                ${imageHTML}
                ${videoHTML}
                <div class="post-date">${postDate}</div>
            `;
            feedEl.appendChild(postCard);
        }

        function extractYouTubeId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
            const match = url.match(regex);
            return (match && match[1]) ? match[1] : null;
        }
    </script>
</body>
</html>
